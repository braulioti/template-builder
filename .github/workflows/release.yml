name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Build MSI
        run: |
          # Install WiX Toolset
          choco install wixtoolset -y
          
          # Copy executable to installer directory
          $installerDir = "${{ github.workspace }}\installer\bin"
          New-Item -ItemType Directory -Force -Path $installerDir | Out-Null
          Copy-Item "build\bin\Release\TemplateBuilder.exe" -Destination "$installerDir\TemplateBuilder.exe"
          
          # Find WiX Toolset installation
          $wixPaths = @(
            "$env:ProgramFiles(x86)\WiX Toolset v3.11\bin",
            "$env:ProgramFiles\WiX Toolset v3.11\bin"
          )
          
          $wixDir = $null
          foreach ($path in $wixPaths) {
            if (Test-Path $path) {
              $wixDir = $path
              Write-Host "Found WiX at: $wixDir"
              break
            }
          }
          
          if ($wixDir) {
            # Build MSI using WiX
            $candle = "$wixDir\candle.exe"
            $light = "$wixDir\light.exe"
            
            Write-Host "Running candle..."
            & $candle "${{ github.workspace }}\installer\TemplateBuilder.wxs" -dSourceDir="$installerDir" -o "$installerDir\"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Candle failed with exit code $LASTEXITCODE"
              exit 1
            }
            
            Write-Host "Running light..."
            & $light "$installerDir\TemplateBuilder.wixobj" -o "$installerDir\TemplateBuilder.msi"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Light failed with exit code $LASTEXITCODE"
              exit 1
            }
            
            # Verify MSI was created
            $msiPath = "$installerDir\TemplateBuilder.msi"
            if (Test-Path $msiPath) {
              Write-Host "MSI created successfully at: $msiPath"
              Get-Item $msiPath | Select-Object Name, Length
            } else {
              Write-Error "MSI file not found after build"
              exit 1
            }
          } else {
            Write-Warning "WiX Toolset not found in standard locations, creating zip instead"
            Compress-Archive -Path "$installerDir\TemplateBuilder.exe" -DestinationPath "$installerDir\TemplateBuilder-windows.zip"
          }

      - name: List files before upload
        run: |
          Write-Host "Files in installer/bin:"
          Get-ChildItem -Path "installer\bin" -Recurse | ForEach-Object { Write-Host $_.FullName }
          Write-Host "Files in build/bin/Release:"
          Get-ChildItem -Path "build\bin\Release" | ForEach-Object { Write-Host $_.FullName }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            build/bin/Release/TemplateBuilder.exe
            installer/bin/TemplateBuilder.msi
            installer/bin/*.zip
          if-no-files-found: error

  linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF
          cmake --build build

      - name: Package (.tar.gz)
        run: |
          cd build
          tar -czvf ../template-builder-linux.tar.gz bin/TemplateBuilder
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            template-builder-linux.tar.gz
            build/bin/TemplateBuilder
          if-no-files-found: warn

  macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF
          cmake --build build

      - name: Package (.tar.gz)
        run: |
          cd build
          tar -czvf ../template-builder-macos.tar.gz bin/TemplateBuilder
          cd ..

      - name: Build PKG
        continue-on-error: true
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          pkgbuild \
            --root build/bin \
            --identifier com.templatebuilder.app \
            --version "$VERSION" \
            --install-location /usr/local/bin \
            template-builder.pkg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: |
            template-builder-macos.tar.gz
            template-builder.pkg
            build/bin/TemplateBuilder
          if-no-files-found: warn

  release:
    needs: [windows, linux, macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: List downloaded files
        run: |
          echo "Files in release directory:"
          find release -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/windows/TemplateBuilder.exe
            release/windows/TemplateBuilder.msi
            release/windows/*.zip
            release/linux/template-builder-linux.tar.gz
            release/linux/TemplateBuilder
            release/macos/template-builder-macos.tar.gz
            release/macos/template-builder.pkg
            release/macos/TemplateBuilder
          generate_release_notes: true
